name: Build and Release aspnetcore JS

on:
  workflow_dispatch:
  schedule:
    # 每月1号早上 8 点执行 (UTC 时间)
    - cron: '0 8 1 * *'

permissions:
  contents: write

jobs:

  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_release.outputs.tag }}
      name: ${{ steps.get_release.outputs.name }}
      skip: ${{ steps.check_existing.outputs.skip }}

    steps:
      - name: 获取最新 aspnetcore 发行版信息
        id: get_release
        run: |
          latest=$(curl -s https://api.github.com/repos/dotnet/aspnetcore/releases/latest)
          tag=$(echo "$latest" | jq -r '.tag_name')
          name=$(echo "$latest" | jq -r '.name')
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT

      - name: 检查是否已发布过该版本
        id: check_existing
        run: |
          existing=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.get_release.outputs.tag }} \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" | jq -r '.id // empty')
          if [ -n "$existing" ]; then
            echo "该版本已存在，跳过构建。"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: 输出检查结果
        run: |
          echo "Tag: ${{ steps.get_release.outputs.tag }}"
          echo "Skip: ${{ steps.check_existing.outputs.skip }}"


  build-and-release:
    needs: check
    if: needs.check.outputs.skip != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: 克隆 aspnetcore 对应版本分支
        run: |
          git clone --depth=1 --branch "${{ needs.check.outputs.tag }}" https://github.com/dotnet/aspnetcore.git
          cd aspnetcore
          git log -1 --oneline

      - name: 安装最新 LTS 版本 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: 修改 tsconfig.json 中 target 为 ES2019
        working-directory: aspnetcore/src/Components/Shared.JS
        run: |
          jq '.compilerOptions.target = "ES2019"' tsconfig.json > tmp.json && mv tmp.json tsconfig.json
          echo "修改后的 tsconfig.json:"
          cat tsconfig.json

      - name: 构建项目
        working-directory: aspnetcore
        run: |
          npm ci
          npm run build

      - name: 收集构建产物
        run: |
          mkdir artifacts
          cp -r aspnetcore/src/Components/Web.JS/dist/Release/* artifacts/
          ls -la artifacts

      - name: 重命名 JS 及 MAP 文件为 *.es2019.js / *.es2019.js.map
        run: |
          # 重命名普通 JS 文件
          for f in artifacts/*.js; do
            # 跳过 .js.map 文件
            if [[ "$f" == *.js.map ]]; then
              continue
            fi
            mv "$f" "${f%.js}.es2019.js"
          done

          # 重命名 JS.map 文件
          for f in artifacts/*.js.map; do
            base="${f%.js.map}"        # 去掉 .js.map
            mv "$f" "${base}.es2019.js.map"
          done

          echo "重命名后的文件："
          ls -la artifacts

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check.outputs.tag }}
          name: ${{ needs.check.outputs.name }}
          body: "Automated build of aspnetcore JavaScript assets for ${{ needs.check.outputs.tag }}"
          files: |
            artifacts/**
